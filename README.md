# PubSub Service

Сервис реализует простую шину событий (Pub/Sub) по принципу Publisher–Subscriber с сохранением порядка (FIFO), локализацией back-pressure и поддержкой graceful shutdown.

## Архитектура

* **pkg/subpub** — внутренний пакет шины:

  * `SubPub` (интерфейс): публичный API шины.
  * `broker`, `topic`, `subscription` — скрытые реализации, обеспечивающие:

    * FIFO-доставку сообщений.
    * Независимые буферы для подписчиков (быстрые не блокируются медленными).
    * Корректное завершение (`Close(ctx)` учитывает контекст).

* **pkg/config** — внутренний пакет для работы с конфигом:
  * `Server` - содержит структуру для маппинга настроек сервера из yml файла.
  * `Bus` - содержит структуру для маппинга настроек шины из yml файла.

* **cmd/server** — gRPC-сервер поверх `pkg/subpub`:

  * `server.go` реализует методы `Publish` и `Subscribe` из `pubsub.proto`.
  * `main.go` запускает gRPC-сервер на порту `50051` (можно поменять в конфиге).

* **cmd/client** — CLI-клиент для демонстрации:

  * Поддерживает режимы `sub` (подписаться и слушать события) и `pub` (опубликовать одно сообщение).

* **configs** - Конфиг для внутренних настроек
  * В него можно прописать порты и прочие параметры

## Особенности реализации и используемые паттерны

* **Dependency Injection**

  * В `server.go` шина (`subpub.SubPub`) передаётся в обработчик через конструктор `NewServer()`.
  * Это упрощает тестирование — можно передать фейковую или метрифицированную реализацию `SubPub`.

* **Graceful Shutdown**

  * В `cmd/server/main.go` при получении `SIGINT/SIGTERM` создаётся `context.WithCancel`, и gRPC-сервер корректно завершается через `GracefulStop()`.
  * Пакет `subpub` использует `Close(ctx)` с учётом контекста, гарантируя, что dispatcher-горутины завершат доставку уже опубликованных сообщений.
  * В `cmd/client/main.go` при получении `SIGINT/SIGTERM` создаётся `context.WithCancel`, и gRPC-клиент корректно завершается, отписываясь от топика и освобождая горутины.

## Сборка и запуск

```bash
# Сборка
go build -o bin/server ./cmd/server
go build -o bin/client ./cmd/client

# Запуск сервера
./bin/server

# В другом терминале: Запуск клиента в режиме подписки
./bin/client -mode=sub -key=chat

# В другом терминале: Публикация сообщений
./bin/client -mode=pub -key=chat -msg="Hello, PubSub!"
```

## Тесты

```bash
go test ./pkg/subpub/  # unit-тесты для шины
# Интеграционные тесты можно добавить в отдельный пакет cmd/...
```
